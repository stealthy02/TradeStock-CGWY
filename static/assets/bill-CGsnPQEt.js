import{ae as V,I as w,O as Ae,o as b,c as E,h as s,e as L,f as o,a as l,az as He,aF as Ge,ac as v,aG as Je,aA as Ke,B as Qe,s as le,t as _,F as We,ax as Xe,ar as Ze,as as et,aB as tt,av as at,b as r,V as d,an as nt,aC as g,ai as lt,aj as ot,ap as N}from"./.pnpm-B0XLMEKp.js";import{c as rt,e as ut,f as st,h as it,i as dt}from"./purchase-D8MZpE6K.js";import{h as pe}from"./basic-Com0UItg.js";import{r as S}from"./request-DINYhP-L.js";import{_ as pt}from"./index-CnvvL9sG.js";const mt={class:"page-container"},vt={key:0},ct={style:{"margin-bottom":"16px","padding-bottom":"16px","border-bottom":"1px solid #f0f0f0"}},ft={style:{"margin-top":"16px"}},_t={style:{"margin-bottom":"24px"}},yt={key:0,style:{color:"#ff4d4f","font-size":"12px","margin-top":"4px"}},gt={class:"modal-footer"},kt={__name:"bill",setup(xt){const j=r(!0),T=r([]),i=V({page_num:1,page_size:10,supplier_name:void 0,pay_status:void 0,invoice_status:void 0,min_amount:void 0,max_amount:void 0}),q=r([]),me=r(0),A=r(!1),H=r(!1),n=r(null),G=r([]),J=r([]),K=r(!1),Q=r(1),oe=r(10),D=r(!1),W=r(null),m=V({bill_id:void 0,pay_date:w(),pay_amount:void 0,pay_method:void 0,remark:""}),X=r(""),F=r([{label:"微信",value:"微信"},{label:"支付宝",value:"支付宝"},{label:"银行卡",value:"银行卡"},{label:"现金",value:"现金"}]),ve=V({pay_date:[{required:!0,message:"请选择付款日期",trigger:"change"}],pay_amount:[{required:!0,message:"请输入付款金额",trigger:"blur",type:"number"},{type:"number",min:.01,message:"付款金额必须为正数",trigger:"blur"}],pay_method:[{required:!0,message:"请选择付款方式",trigger:"change"}]}),M=r(!1),Z=r("修改开票状态"),ee=r(""),R=V({bill_id:void 0,invoice_status:0}),Y=r(!1),re=r(""),te=r(void 0),U=r(!1),P=r(void 0),$=r(!1),ce=r(""),ue=r(void 0),I=r(!1),se=r(""),ae=r(void 0),c=r(null),z=r(null),O=r(null),fe=[{title:"供货商名称",dataIndex:"supplier_name",key:"supplier_name",sorter:!0,ellipsis:!0},{title:"起始日期",dataIndex:"start_date",key:"start_date",sorter:!0,ellipsis:!0,customRender:function(t){return t.record.start_date||"-"}},{title:"结束日期",dataIndex:"end_date",key:"end_date",sorter:!0,ellipsis:!0,customRender:function(t){return t.record.end_date||"未确定"}},{title:"对账金额",dataIndex:"bill_amount",key:"bill_amount",sorter:!0,ellipsis:!0,customRender:function(t){return t.record.bill_amount?t.record.bill_amount.toFixed(2):"0.00"}},{title:"已付金额",dataIndex:"received_amount",key:"received_amount",sorter:!0,ellipsis:!0,customRender:function(t){return t.record.received_amount?t.record.received_amount.toFixed(2):"0.00"}},{title:"未付金额",dataIndex:"unreceived_amount",key:"unreceived_amount",sorter:!0,ellipsis:!0,customRender:function(t){return t.record.unreceived_amount?t.record.unreceived_amount.toFixed(2):"0.00"}},{title:"结款状态",dataIndex:"pay_status",key:"pay_status",sorter:!0,ellipsis:!0,customRender:function(t){return t.record.pay_status===1?g(N,{color:"success"},()=>"已结清"):g(N,{color:"error"},()=>"未结清")}},{title:"开票状态",dataIndex:"invoice_status",key:"invoice_status",sorter:!0,ellipsis:!0,customRender:function(t){return t.record.invoice_status===1?g(N,{color:"blue"},()=>"已开票"):g(N,{color:"default"},()=>"未开票")}},{title:"操作",key:"action",fixed:"right",width:250,customRender:function(t){const e=t.record,u=!!e.end_date;return g("div",[g("span",{style:{display:"inline-block",marginRight:"8px",cursor:"pointer",color:"#1890ff"},onClick:()=>he(e)},"查看细则"),g("span",{style:{display:"inline-block",marginRight:"8px",cursor:"pointer",color:"#1890ff",opacity:!u||e.pay_status===1?.5:1,pointerEvents:!u||e.pay_status===1?"none":"auto"},onClick:()=>Me(e)},"录入付款"),g("span",{style:{display:"inline-block",marginRight:"8px",cursor:"pointer",color:"#1890ff",opacity:u?1:.5,pointerEvents:u?"auto":"none"},onClick:()=>Ie(e)},"修改开票状态")])}}],_e=[{title:"商品名称",dataIndex:"product_name",key:"product_name",ellipsis:!0},{title:"采购日期",dataIndex:"purchase_date",key:"purchase_date",ellipsis:!0},{title:"总公斤数",dataIndex:"total_kg",key:"total_kg",ellipsis:!0},{title:"单价",dataIndex:"unit_price",key:"unit_price",ellipsis:!0,customRender:function(t){return t.record.unit_price?t.record.unit_price.toFixed(2):"0.00"}},{title:"采购总价",dataIndex:"total_price",key:"total_price",ellipsis:!0,customRender:function(t){return t.record.total_price.toFixed(2)}},{title:"备注",dataIndex:"remark",key:"remark",ellipsis:!0,customRender:function(t){return t.record.remark||"-"}}],ye=[{title:"付款日期",dataIndex:"pay_date",key:"pay_date",ellipsis:!0},{title:"付款金额",dataIndex:"pay_amount",key:"pay_amount",ellipsis:!0,customRender:function(t){return t.record.pay_amount.toFixed(2)}},{title:"付款方式",dataIndex:"pay_method",key:"pay_method",ellipsis:!0},{title:"备注",dataIndex:"remark",key:"remark",ellipsis:!0,customRender:function(t){return t.record.remark||"-"}},{title:"操作",key:"action",fixed:"right",width:100,customRender:function(t){const e=t.record;return g("span",{style:{display:"inline-block",cursor:"pointer",color:"#ff4d4f"},onClick:()=>Pe(e)},"删除")}}],f=async()=>{A.value=!0;try{const t=await rt(i);q.value=t.data.list,me.value=t.data.total}catch(t){console.error("获取采购对账单列表失败:",t),d.error("获取数据失败，请稍后重试")}finally{A.value=!1}},ge=t=>{i.page_num=t,f()},ke=(t,e)=>{i.page_size=e,i.page_num=1,f()},xe=()=>{i.page_num=1,i.page_size=10,i.supplier_name=void 0,i.pay_status=void 0,i.invoice_status=void 0,i.min_amount=void 0,i.max_amount=void 0,f()},be=()=>{d.info("请在细则中点击导出按钮")},we=async()=>{if(!n.value){d.error("请先选择对账单");return}try{const t={bill_id:n.value.id};c.value&&(t.end_date=c.value.format("YYYY-MM-DD"));const e=await ut(t),u=window.URL.createObjectURL(e),p=document.createElement("a");p.href=u;const y=`采购对账单_${n.value.supplier_name}_${w().format("YYYYMMDDHHmmss")}.xlsx`;p.download=y,document.body.appendChild(p),p.click(),document.body.removeChild(p),window.URL.revokeObjectURL(u),d.success("导出成功")}catch(t){console.error("导出失败:",t),d.error("导出失败，请稍后重试")}},Ce=async t=>{if(t)try{const e=await pe({keyword:t});T.value=e.data.map(u=>({label:u,value:u}))}catch(e){console.error("获取供货商列表失败:",e)}},he=async t=>{n.value=t,H.value=!0,c.value=w(),z.value=null,O.value=null,await k(t.id,t.supplier_id)},k=async(t,e)=>{K.value=!0;try{const u={bill_id:t};t===0&&e&&(u.supplier_id=e),c.value&&(u.end_date=c.value.format("YYYY-MM-DD"));const p=await it(u);G.value=p.data.purchase_list.list,J.value=p.data.pay_record_list.list,p.data.bill_info&&(n.value=p.data.bill_info,z.value=p.data.bill_info.bill_amount,O.value=p.data.bill_info.unreceived_amount)}catch(u){console.error("获取采购对账单细则失败:",u),d.error("获取细则失败，请稍后重试"),G.value=[],J.value=[]}finally{K.value=!1}},Se=t=>{Q.value=t,n.value&&k(n.value.id)},De=(t,e)=>{oe.value=e,Q.value=1,n.value&&k(n.value.id)},Me=t=>{if(t.pay_status===1){d.warning("该对账单已全部结清，无需再次付款");return}m.bill_id=t.id,m.pay_date=w(),m.pay_amount=void 0,m.pay_method=void 0,m.remark="",X.value="",D.value=!0},Re=t=>{if(!t)return;F.value.some(u=>u.value===t)||(F.value=[{label:t,value:t},...F.value])},Ye=t=>{m.pay_method=t},Ue=async()=>{if(W.value)try{if(await W.value.validate(),n.value&&m.pay_amount&&m.pay_amount>n.value.unreceived_amount){d.error(`付款金额不可超过未付金额${n.value.unreceived_amount.toFixed(2)}元`);return}const t={...m,pay_date:w.isDayjs(m.pay_date)?m.pay_date.format("YYYY-MM-DD"):m.pay_date},e=await st(t);d.success("付款成功！"),e.data.pay_status===1&&d.success("该对账单已全部结清"),D.value=!1,f(),n.value&&k(n.value.id)}catch(t){console.error("提交付款失败:",t),d.error("提交失败，请稍后重试")}},Ie=t=>{R.bill_id=t.id,t.invoice_status===0?(Z.value="标记为已开票",ee.value=`确定将${t.supplier_name}的采购对账单标记为已开票吗？`,R.invoice_status=1):(Z.value="标记为未开票",ee.value=`确定将${t.supplier_name}的采购对账单标记为未开票吗？`,R.invoice_status=0),M.value=!0},Fe=async()=>{if(R.bill_id)try{await dt(R),d.success("开票状态更新成功"),M.value=!1,f()}catch(t){console.error("更新开票状态失败:",t),d.error("更新失败，请稍后重试")}},Pe=t=>{te.value=t.id,re.value=`确定要删除这条付款记录吗？付款金额：${t.pay_amount.toFixed(2)}元，付款日期：${t.pay_date}`,Y.value=!0},$e=async()=>{if(te.value)try{await S({url:"/purchase/bill/pay/delete",method:"delete",params:{payment_id:te.value}}),d.success("付款记录删除成功"),Y.value=!1,n.value&&await k(n.value.id),f()}catch(t){console.error("删除付款记录失败:",t),d.error("删除失败，请稍后重试")}},ze=t=>{if(!c.value){d.warning("请先在细则中选择对账结束日期");return}P.value=t.id,U.value=!0},Oe=t=>{if(!n.value||!n.value.start_date)return!1;const e=w(n.value.start_date);return t&&t<e},Be=async t=>{!t||!n.value||(c.value=t,await k(n.value.id,n.value.supplier_id))},Ve=async()=>{if(P.value)try{const t=w.isDayjs(c.value)?c.value.format("YYYY-MM-DD"):c.value;let e;if(P.value===0){const u=n.value.supplier_name;if(!u){d.error("无法获取供货商信息，请稍后重试");return}const y=(await S({url:"/purchase/statement/last",method:"get",params:{supplier_name:u}})).data.next_start_date||t;await S({url:"/purchase/statement/create",method:"post",data:{supplier_name:u,start_date:y}}),await f();const C=q.value.find(B=>B.supplier_name===u&&!B.end_date);if(!C){d.error("无法找到新创建的对账单，请稍后重试");return}e={statement_id:C.id,end_date:t}}else e={statement_id:P.value,end_date:t};await S({url:"/purchase/statement/confirm",method:"post",data:e}),d.success("对账单确认成功"),U.value=!1,f(),n.value&&await k(n.value.id,n.value.supplier_id)}catch(t){console.error("确认对账单失败:",t),d.error("确认失败，请稍后重试")}},Ee=async()=>{if(ue.value)try{const t=await S({url:"/purchase/statement/delete",method:"delete",params:{statement_id:ue.value}});d.success("对账单删除成功"),$.value=!1,f()}catch(t){console.error("删除对账单失败:",t),d.error("删除失败，请稍后重试")}},Le=t=>{t.end_date&&(ae.value=t.id,se.value="确定要取消确认此对账单吗？取消后，该对账单的结束日期将被设为未确定，对应的采购记录将可以重新编辑。",I.value=!0)},Ne=async()=>{if(ae.value)try{const t=await S({url:"/purchase/statement/unconfirm",method:"post",params:{statement_id:ae.value}});d.success("对账单取消确认成功"),I.value=!1,f(),n.value&&await k(n.value.id,n.value.supplier_id)}catch(t){console.error("取消确认对账单失败:",t),d.error("取消确认失败，请稍后重试")}};return Ae(async()=>{try{const t=await pe();T.value=t.data.map(e=>({label:e,value:e}))}catch(t){console.error("获取供货商列表失败:",t)}f()}),(t,e)=>{const u=He,p=et,y=Ge,C=Ke,B=Je,x=Qe,ie=Ze,je=nt,ne=Xe,de=tt,Te=lt,qe=at,h=ot;return b(),E("div",mt,[e[52]||(e[52]=s("h1",null,"采购对账单管理",-1)),j.value?(b(),L(ie,{key:0,model:i,layout:"inline",style:{"margin-bottom":"16px",padding:"16px",background:"#fafafa","border-radius":"8px"}},{default:o(()=>[l(p,{label:"供货商名称"},{default:o(()=>[l(u,{value:i.supplier_name,"onUpdate:value":e[0]||(e[0]=a=>i.supplier_name=a),placeholder:"请选择供货商","show-search":"","filter-option":!1,options:T.value,onSearch:Ce,style:{width:"200px"}},null,8,["value","options"])]),_:1}),l(p,{label:"结款状态"},{default:o(()=>[l(u,{value:i.pay_status,"onUpdate:value":e[1]||(e[1]=a=>i.pay_status=a),placeholder:"请选择结款状态",style:{width:"150px"}},{default:o(()=>[l(y,{value:""},{default:o(()=>[...e[26]||(e[26]=[v("全部",-1)])]),_:1}),l(y,{value:0},{default:o(()=>[...e[27]||(e[27]=[v("未结清",-1)])]),_:1}),l(y,{value:1},{default:o(()=>[...e[28]||(e[28]=[v("已结清",-1)])]),_:1})]),_:1},8,["value"])]),_:1}),l(p,{label:"开票状态"},{default:o(()=>[l(u,{value:i.invoice_status,"onUpdate:value":e[2]||(e[2]=a=>i.invoice_status=a),placeholder:"请选择开票状态",style:{width:"150px"}},{default:o(()=>[l(y,{value:""},{default:o(()=>[...e[29]||(e[29]=[v("全部",-1)])]),_:1}),l(y,{value:0},{default:o(()=>[...e[30]||(e[30]=[v("未开票",-1)])]),_:1}),l(y,{value:1},{default:o(()=>[...e[31]||(e[31]=[v("已开票",-1)])]),_:1})]),_:1},8,["value"])]),_:1}),l(p,{label:"对账金额范围"},{default:o(()=>[l(B,{compact:""},{default:o(()=>[l(C,{value:i.min_amount,"onUpdate:value":e[3]||(e[3]=a=>i.min_amount=a),placeholder:"最小",min:0,step:.01,precision:2,style:{width:"100px"}},null,8,["value"]),e[32]||(e[32]=s("span",{style:{margin:"0 8px"}},"-",-1)),l(C,{value:i.max_amount,"onUpdate:value":e[4]||(e[4]=a=>i.max_amount=a),placeholder:"最大",min:0,step:.01,precision:2,style:{width:"100px"}},null,8,["value"])]),_:1})]),_:1}),l(p,null,{default:o(()=>[l(x,{type:"primary",onClick:f},{default:o(()=>[...e[33]||(e[33]=[v("查询",-1)])]),_:1}),l(x,{style:{"margin-left":"8px"},onClick:xe},{default:o(()=>[...e[34]||(e[34]=[v("重置",-1)])]),_:1}),l(x,{style:{"margin-left":"8px"},onClick:be},{default:o(()=>[...e[35]||(e[35]=[v("导出",-1)])]),_:1})]),_:1})]),_:1},8,["model"])):le("",!0),l(je,{checked:j.value,"onUpdate:checked":e[5]||(e[5]=a=>j.value=a),style:{"margin-bottom":"16px"}},{default:o(()=>[...e[36]||(e[36]=[v("显示搜索栏",-1)])]),_:1},8,["checked"]),l(ne,{columns:fe,"data-source":q.value,"row-key":a=>a.id,pagination:{showSizeChanger:!0,pageSizeOptions:["10","20","50","100"],showTotal:a=>`共 ${a} 条记录`,current:i.page_num,pageSize:i.page_size,onChange:ge,onShowSizeChange:ke},scroll:{x:1200},loading:A.value},null,8,["data-source","row-key","pagination","loading"]),l(Te,{title:"采购对账单细则",placement:"right",width:800,open:H.value,onClose:e[9]||(e[9]=a=>H.value=!1)},{extra:o(()=>[l(x,{type:"primary",onClick:we},{default:o(()=>[...e[37]||(e[37]=[v("导出",-1)])]),_:1})]),default:o(()=>[n.value?(b(),E("div",vt,[s("div",ct,[s("p",null,[e[38]||(e[38]=s("strong",null,"供货商名称：",-1)),v(_(n.value.supplier_name||"-"),1)]),s("p",null,[e[39]||(e[39]=s("strong",null,"对账开始日期：",-1)),v(_(n.value.start_date||"-"),1)]),s("p",null,[e[40]||(e[40]=s("strong",null,"对账结束日期：",-1)),n.value.end_date?(b(),E(We,{key:1},[v(_(n.value.end_date),1)],64)):(b(),L(de,{key:0,value:c.value,"onUpdate:value":e[6]||(e[6]=a=>c.value=a),format:"YYYY-MM-DD",style:{width:"150px","margin-left":"8px"},"disabled-date":Oe,onChange:Be},null,8,["value"]))]),s("p",null,[e[41]||(e[41]=s("strong",null,"对账金额：",-1)),v(_(z.value?z.value.toFixed(2):n.value.bill_amount?n.value.bill_amount.toFixed(2):"0.00")+" 元",1)]),s("p",null,[e[42]||(e[42]=s("strong",null,"已付金额：",-1)),v(_(n.value.received_amount?n.value.received_amount.toFixed(2):"0.00")+" 元",1)]),s("p",null,[e[43]||(e[43]=s("strong",null,"未付金额：",-1)),v(_(O.value?O.value.toFixed(2):n.value.unreceived_amount?n.value.unreceived_amount.toFixed(2):"0.00")+" 元",1)]),s("div",ft,[n.value.end_date?(b(),L(x,{key:1,type:"default",onClick:e[8]||(e[8]=a=>Le(n.value))},{default:o(()=>[...e[45]||(e[45]=[v(" 撤销确认 ",-1)])]),_:1})):(b(),L(x,{key:0,type:"primary",onClick:e[7]||(e[7]=a=>ze(n.value))},{default:o(()=>[...e[44]||(e[44]=[v(" 确认对账单 ",-1)])]),_:1}))])]),s("div",_t,[e[46]||(e[46]=s("h3",null,"采购明细",-1)),l(ne,{columns:_e,"data-source":G.value,"row-key":a=>a.id,pagination:{showSizeChanger:!0,pageSizeOptions:["10","20","50"],showTotal:a=>`共 ${a} 条记录`,current:Q.value,pageSize:oe.value,onChange:Se,onShowSizeChange:De},loading:K.value},null,8,["data-source","row-key","pagination","loading"])]),s("div",null,[e[48]||(e[48]=s("h3",null,"付款记录",-1)),l(ne,{columns:ye,"data-source":J.value,"row-key":a=>a.id,pagination:!1},{empty:o(()=>[...e[47]||(e[47]=[s("p",null,"暂无付款记录",-1)])]),_:1},8,["data-source","row-key"])])])):le("",!0)]),_:1},8,["open"]),l(h,{open:D.value,"onUpdate:open":e[15]||(e[15]=a=>D.value=a),title:"录入付款",width:"600px",destroyOnClose:""},{footer:o(()=>[s("div",gt,[l(x,{onClick:e[14]||(e[14]=a=>D.value=!1)},{default:o(()=>[...e[49]||(e[49]=[v("取消",-1)])]),_:1}),l(x,{type:"primary",onClick:Ue},{default:o(()=>[...e[50]||(e[50]=[v("确定",-1)])]),_:1})])]),default:o(()=>[l(ie,{ref_key:"payFormRef",ref:W,model:m,rules:ve,layout:"vertical"},{default:o(()=>[l(p,{label:"付款日期",name:"pay_date"},{default:o(()=>[l(de,{value:m.pay_date,"onUpdate:value":e[10]||(e[10]=a=>m.pay_date=a),format:"YYYY-MM-DD",style:{width:"100%"}},null,8,["value"])]),_:1}),l(p,{label:"付款金额",name:"pay_amount"},{default:o(()=>[l(C,{value:m.pay_amount,"onUpdate:value":e[11]||(e[11]=a=>m.pay_amount=a),min:.01,step:.01,precision:2,placeholder:"请输入付款金额",style:{width:"100%"}},null,8,["value"]),X.value?(b(),E("div",yt,_(X.value),1)):le("",!0)]),_:1}),l(p,{label:"付款方式",name:"pay_method"},{default:o(()=>[l(u,{value:m.pay_method,"onUpdate:value":e[12]||(e[12]=a=>m.pay_method=a),placeholder:"请选择付款方式",style:{width:"100%"},options:F.value,"not-found-content":"输入新的付款方式后按回车",onSearch:Re,onChange:Ye},null,8,["value","options"])]),_:1}),l(p,{label:"付款备注",name:"remark"},{default:o(()=>[l(qe,{value:m.remark,"onUpdate:value":e[13]||(e[13]=a=>m.remark=a),rows:4,maxLength:200,placeholder:"请输入付款备注"},null,8,["value"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["open"]),l(h,{open:M.value,"onUpdate:open":e[16]||(e[16]=a=>M.value=a),title:Z.value,onOk:Fe,onCancel:e[17]||(e[17]=a=>M.value=!1)},{default:o(()=>[s("p",null,_(ee.value),1)]),_:1},8,["open","title"]),l(h,{open:Y.value,"onUpdate:open":e[18]||(e[18]=a=>Y.value=a),title:"删除付款记录",onOk:$e,onCancel:e[19]||(e[19]=a=>Y.value=!1)},{default:o(()=>[s("p",null,_(re.value),1)]),_:1},8,["open"]),l(h,{open:U.value,"onUpdate:open":e[20]||(e[20]=a=>U.value=a),title:"确认采购对账单",width:"600px",onOk:Ve,onCancel:e[21]||(e[21]=a=>U.value=!1)},{default:o(()=>[...e[51]||(e[51]=[s("p",null,"确定要确认此对账单吗？结束日期将使用细则中选择的日期。",-1)])]),_:1},8,["open"]),l(h,{open:$.value,"onUpdate:open":e[22]||(e[22]=a=>$.value=a),title:"删除对账单",onOk:Ee,onCancel:e[23]||(e[23]=a=>$.value=!1)},{default:o(()=>[s("p",null,_(ce.value),1)]),_:1},8,["open"]),l(h,{open:I.value,"onUpdate:open":e[24]||(e[24]=a=>I.value=a),title:"取消确认采购对账单",onOk:Ne,onCancel:e[25]||(e[25]=a=>I.value=!1)},{default:o(()=>[s("p",null,_(se.value),1)]),_:1},8,["open"])])}}},Dt=pt(kt,[["__scopeId","data-v-99d3c218"]]);export{Dt as default};
