import{d as re,ae as D,I as c,O as se,c as oe,h as ne,a as s,f as n,e as le,s as ue,b as i,u as pe,U as ie,V as v,B as ce,ar as de,an as me,ax as _e,aj as b,o as A,ac as h,i as fe,ay as he,az as ge,as as ye,at as ve,aA as be,aB as ke,av as we,aC as w,aD as xe,aE as Se}from"./.pnpm-B0XLMEKp.js";import{s as R,g as Ce,a as Pe,u as De,b as Re,d as Ie}from"./purchase-D8MZpE6K.js";import{h as M}from"./basic-Com0UItg.js";import{r as ze}from"./request-DINYhP-L.js";import{_ as Oe}from"./index-CnvvL9sG.js";const Ue={class:"page-container"},Ye=re({__name:"info",setup(qe){const g=i(!1),I=i("新增采购信息"),x=i(!0),k=i([]),d=i([]),_=i([]),z=i([]),B=i(0),S=i(!1),y=i(),j=pe(),u=D({page_num:1,page_size:10,supplier_name:"",product_name:""}),t=D({id:void 0,supplier_name:"",product_name:"",product_spec:"",purchase_num:void 0,purchase_price:void 0,purchase_date:c(),remark:"",supplier_id:void 0}),T=D({supplier_name:[{required:!0,message:"请选择供货商",trigger:"change"}],product_name:[{required:!0,message:"请输入商品名称",trigger:"blur",type:"string"}],product_spec:[{required:!0,message:"请输入商品规格",trigger:"blur",type:"string"}],purchase_num:[{required:!0,message:"请输入采购数量",trigger:"blur",type:"number"},{type:"number",min:1,message:"采购数量必须为正整数",trigger:"blur"}],purchase_price:[{required:!0,message:"请输入采购单价",trigger:"blur",type:"number"},{type:"number",min:.01,message:"采购单价必须为正数",trigger:"blur"}],purchase_date:[{required:!0,message:"请选择采购日期",trigger:"change",type:"date"}]}),V=ie(()=>[{title:"供货商名称",dataIndex:"supplier_name",key:"supplier_name",sorter:!0,ellipsis:!0},{title:"商品名称",dataIndex:"product_name",key:"product_name",sorter:!0,ellipsis:!0},{title:"商品规格",dataIndex:"product_spec",key:"product_spec",sorter:!0,ellipsis:!0,customRender:a=>a.record.product_spec||"-"},{title:"采购数量",dataIndex:"purchase_num",key:"purchase_num",sorter:!0,ellipsis:!0},{title:"采购单价",dataIndex:"purchase_price",key:"purchase_price",sorter:!0,ellipsis:!0,customRender:a=>a.record.purchase_price.toFixed(2)},{title:"采购总价",dataIndex:"total_price",key:"total_price",sorter:!0,ellipsis:!0,customRender:a=>a.record.total_price.toFixed(2)},{title:"采购日期",dataIndex:"purchase_date",key:"purchase_date",sorter:!0,ellipsis:!0},{title:"备注",dataIndex:"remark",key:"remark",ellipsis:!0,customRender:a=>{const e=a.record.remark;if(!e)return"-";const r=e.length>4?e.substring(0,4)+"...":e;return w(xe,{title:e},{default:()=>r})}},{title:"操作",key:"action",fixed:"right",width:80,customRender:({record:a})=>w("div",[w("span",{style:{display:"inline-block",padding:"2px 8px",backgroundColor:"#ff4d4f",color:"#fff",borderRadius:"2px",cursor:"pointer",fontSize:"12px"},onClick:()=>X(a.id)},"删")])}]),m=async a=>{S.value=!0;try{const e={...u,...a&&{id:a}},r=await Ce(e);z.value=r.data.list,B.value=r.data.total}catch(e){console.error("获取采购信息列表失败:",e),v.error("获取数据失败，请稍后重试")}finally{S.value=!1}},N=a=>{u.page_num=a,m()},$=(a,e)=>{u.page_size=e,u.page_num=1,m()},F=()=>{u.page_num=1,u.page_size=10,u.supplier_name="",u.product_name="",_.value=[],m()},O=async a=>{if(a)try{const e=await M({keyword:a});k.value=e.data.map(r=>({label:r,value:r}))}catch(e){console.error("获取供货商列表失败:",e)}},L=async a=>{typeof a=="string"&&t.product_name&&await U(a,t.product_name)},E=async a=>{if(t.product_name=a,!a){d.value=[];return}try{const e=await R({keyword:a});let r=[];Array.isArray(e.data)&&(r=e.data.map(l=>({label:l,value:l}))),d.value=[{label:a,value:a},...r.filter(l=>l.value!==a)]}catch(e){console.error("获取商品列表失败:",e),d.value=[{label:a,value:a}]}},G=async a=>{typeof a=="string"&&t.supplier_name&&await U(t.supplier_name,a)},H=async a=>{if(a)try{const e=await R({keyword:a});Array.isArray(e.data)?_.value=e.data.map(r=>({label:r,value:r})):_.value=[]}catch(e){console.error("获取商品列表失败:",e),_.value=[]}},U=async(a,e)=>{try{const l=(await Pe({supplier_name:a,product_name:e})).data;l&&(l.purchase_price&&(t.purchase_price=l.purchase_price),l.product_spec&&(t.product_spec=l.product_spec))}catch(r){console.error("获取历史单价失败:",r)}},J=()=>{Object.assign(t,{id:void 0,supplier_id:void 0,supplier_name:"",product_name:"",product_spec:"",purchase_num:void 0,purchase_price:void 0,purchase_date:c(),remark:""}),I.value="新增采购信息",g.value=!0},K=async(a,e)=>{var r;try{const p=((r=(await ze({url:"/purchase/bill/list",method:"get",params:{supplier_name:a,page_num:1,page_size:100}})).data)==null?void 0:r.list)||[];for(const f of p)if(f.end_date){const C=c(f.start_date),P=c(f.end_date);if(e.isAfter(C.subtract(1,"day"))&&e.isBefore(P.add(1,"day")))return{inRange:!0,bill:f}}return{inRange:!1}}catch(l){return console.error("检查对账单日期范围失败:",l),{inRange:!1}}},Q=async()=>{if(y.value){try{await y.value.validate()}catch{v.error("请完善表单信息后再提交");return}try{const a=c.isDayjs(t.purchase_date)?t.purchase_date:c(t.purchase_date);if(t.supplier_name){const e=await K(t.supplier_name,a);if(e.inRange){b.confirm({title:"日期范围提醒",content:`您选择的采购日期(${a.format("YYYY-MM-DD")})在已确定的对账单日期范围内(${e.bill.start_date} 至 ${e.bill.end_date})。继续添加可能会导致对账单发生改变，确定要继续吗？`,onOk:async()=>{await Y()}});return}}await Y()}catch(a){console.error("提交失败:",a),b.error({title:"操作失败",content:a.message||"服务器错误，请稍后重试"})}}},Y=async()=>{const a=c.isDayjs(t.purchase_date)?t.purchase_date:c(t.purchase_date),e={...t,purchase_date:a.format("YYYY-MM-DD")};t.id?(await De(e),v.success("修改成功")):(await Re(e),v.success("新增成功")),g.value=!1,m()},W=()=>{y.value&&(y.value.resetFields(),t.id||Object.assign(t,{supplier_id:0,product_name:"",product_spec:"",purchase_num:void 0,purchase_price:void 0,purchase_date:c(),remark:"",supplier_name:""}))},X=a=>{b.confirm({title:"确认删除",icon:()=>w(Se),content:"删除后同步更新对账单、库存，不可恢复",okText:"确认",cancelText:"取消",onOk:async()=>{try{await Ie({id:a}),v.success("删除成功"),m()}catch(e){console.error("删除失败:",e),b.error({title:"删除失败",content:e.message||"服务器错误，请稍后重试"})}}})};return se(async()=>{await Promise.all([(async()=>{try{const e=await M();k.value=e.data.map(r=>({label:r,value:r}))}catch(e){console.error("获取供货商列表失败:",e)}})(),(async()=>{try{const e=await R({});Array.isArray(e.data)?(d.value=e.data.map(r=>({label:r,value:r})),_.value=d.value):(d.value=[],_.value=[])}catch(e){console.error("获取商品列表失败:",e)}})()]);const a=j.query.id;a?m(Number(a)):m()}),(a,e)=>{const r=ce,l=ge,p=ye,f=de,C=me,P=_e,Z=ve,q=be,ee=ke,ae=we,te=b;return A(),oe("div",Ue,[e[20]||(e[20]=ne("h1",null,"采购信息录入/查询",-1)),s(r,{type:"primary",style:{"margin-bottom":"16px"},onClick:J},{icon:n(()=>[s(fe(he))]),default:n(()=>[e[13]||(e[13]=h(" 新增采购信息 ",-1))]),_:1}),x.value?(A(),le(f,{key:0,model:u,layout:"inline",style:{"margin-bottom":"16px"}},{default:n(()=>[s(p,{label:"供货商名称"},{default:n(()=>[s(l,{value:u.supplier_name,"onUpdate:value":e[0]||(e[0]=o=>u.supplier_name=o),placeholder:"请选择供货商","show-search":"","filter-option":!1,options:k.value,onSearch:O,style:{width:"200px"}},null,8,["value","options"])]),_:1}),s(p,{label:"商品名称"},{default:n(()=>[s(l,{value:u.product_name,"onUpdate:value":e[1]||(e[1]=o=>u.product_name=o),placeholder:"请输入商品名称","show-search":"","filter-option":!1,options:_.value,onSearch:H,style:{width:"200px"}},null,8,["value","options"])]),_:1}),s(p,null,{default:n(()=>[s(r,{type:"primary",onClick:e[2]||(e[2]=()=>m())},{default:n(()=>[...e[14]||(e[14]=[h("查询",-1)])]),_:1}),s(r,{style:{"margin-left":"8px"},onClick:F},{default:n(()=>[...e[15]||(e[15]=[h("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])):ue("",!0),s(C,{checked:x.value,"onUpdate:checked":e[3]||(e[3]=o=>x.value=o),style:{"margin-bottom":"16px"}},{default:n(()=>[...e[16]||(e[16]=[h("显示搜索栏",-1)])]),_:1},8,["checked"]),s(P,{columns:V.value,"data-source":z.value,"row-key":o=>o.id,pagination:{showSizeChanger:!0,pageSizeOptions:["10","20","50","100"],showTotal:o=>`共 ${o} 条记录`,current:u.page_num,pageSize:u.page_size,onChange:N,onShowSizeChange:$},scroll:{x:1400},loading:S.value},null,8,["columns","data-source","row-key","pagination","loading"]),s(te,{open:g.value,"onUpdate:open":e[12]||(e[12]=o=>g.value=o),title:I.value,width:"600px",destroyOnClose:"",footer:null},{default:n(()=>[s(f,{ref_key:"formRef",ref:y,model:t,rules:T,layout:"vertical"},{default:n(()=>[s(p,{label:"供货商名称",name:"supplier_name"},{default:n(()=>[s(l,{value:t.supplier_name,"onUpdate:value":e[4]||(e[4]=o=>t.supplier_name=o),placeholder:"请选择供货商","show-search":"","filter-option":!1,options:k.value,onSearch:O,onChange:L},null,8,["value","options"])]),_:1}),s(p,{label:"商品名称",name:"product_name"},{default:n(()=>[s(l,{value:t.product_name,"onUpdate:value":e[5]||(e[5]=o=>t.product_name=o),options:d.value,placeholder:"请输入商品名称","show-search":"","filter-option":!1,onSearch:E,onChange:G,style:{width:"100%"},"not-found-content":d.value.length===0?"输入商品名称后按回车":void 0},null,8,["value","options","not-found-content"])]),_:1}),s(p,{label:"商品规格",name:"product_spec"},{default:n(()=>[s(Z,{value:t.product_spec,"onUpdate:value":e[6]||(e[6]=o=>t.product_spec=o),placeholder:"请输入商品规格，例如：30"},null,8,["value"])]),_:1}),s(p,{label:"采购数量",name:"purchase_num"},{default:n(()=>[s(q,{value:t.purchase_num,"onUpdate:value":e[7]||(e[7]=o=>t.purchase_num=o),min:1,step:1,precision:0,placeholder:"请输入采购数量"},null,8,["value"])]),_:1}),s(p,{label:"采购单价",name:"purchase_price"},{default:n(()=>[s(q,{value:t.purchase_price,"onUpdate:value":e[8]||(e[8]=o=>t.purchase_price=o),min:.01,step:.01,precision:2,placeholder:"请输入采购单价"},null,8,["value"])]),_:1}),s(p,{label:"采购日期",name:"purchase_date"},{default:n(()=>[s(ee,{value:t.purchase_date,"onUpdate:value":e[9]||(e[9]=o=>t.purchase_date=o),format:"YYYY-MM-DD",style:{width:"100%"}},null,8,["value"])]),_:1}),s(p,{label:"备注",name:"remark"},{default:n(()=>[s(ae,{value:t.remark,"onUpdate:value":e[10]||(e[10]=o=>t.remark=o),rows:4,maxLength:200,placeholder:"请输入备注信息"},null,8,["value"])]),_:1}),s(p,{style:{"margin-top":"24px"}},{default:n(()=>[s(r,{type:"primary",onClick:Q},{default:n(()=>[...e[17]||(e[17]=[h("提交",-1)])]),_:1}),s(r,{style:{"margin-left":"8px"},onClick:W},{default:n(()=>[...e[18]||(e[18]=[h("重置",-1)])]),_:1}),s(r,{style:{"margin-left":"8px"},onClick:e[11]||(e[11]=o=>g.value=!1)},{default:n(()=>[...e[19]||(e[19]=[h("取消",-1)])]),_:1})]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["open","title"])])}}}),Ve=Oe(Ye,[["__scopeId","data-v-92cbd9a5"]]);export{Ve as default};
