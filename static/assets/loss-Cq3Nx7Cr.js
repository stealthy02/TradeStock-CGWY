import{d as ne,ae as P,I as U,O as re,c as I,h as q,a as o,f as l,e as F,s as b,b as d,u as ue,U as ie,V as x,B as de,ar as ce,an as pe,ax as _e,ah as me,aj as k,o as h,ac as f,i as ve,ay as fe,az as ge,X as ye,at as xe,as as he,t as L,aA as be,aB as ke,av as we,aC as M,aE as Ce}from"./.pnpm-B0XLMEKp.js";import{a as Ye,g as R,b as ze,d as De}from"./inventory-QY7kwVo4.js";import{_ as Pe}from"./index-CnvvL9sG.js";import"./request-DINYhP-L.js";const Ue={class:"page-container"},Ie={class:"action-bar"},Me={key:0,style:{"margin-top":"8px",color:"#52c41a","font-size":"12px"}},Re={key:0,style:{color:"#ff4d4f","font-size":"12px","margin-top":"4px"}},Se=ne({__name:"loss",setup($e){const g=d(!1),S=d("新建库存报损"),w=d(!0),c=d([]),$=d([]),C=d(0),Y=d(!1),z=d(),D=d(""),V=ue(),v=d([]),n=d(null),p=d(""),i=P({page_num:1,page_size:10}),s=P({product_name:"",product_spec:"",loss_num:1,loss_date:U(),loss_reason:""}),N=P({product_name:[{required:!0,message:"请选择商品",trigger:["blur","change"]},{validator:(t,e)=>e?v.value.some(m=>m.value===e)?Promise.resolve():Promise.reject("商品不存在，请选择已存在的商品"):Promise.resolve(),trigger:["blur","change"]}],product_spec:[{required:!0,message:"请输入商品规格",trigger:["blur","change"]}],loss_num:[{required:!0,message:"请输入报损数量",trigger:["blur","change"]},{type:"number",min:1,message:"报损数量必须为正整数",trigger:["blur","change"]},{validator:(t,e)=>e&&n.value&&e>n.value.inventory_num?Promise.reject(`库存不足，当前${s.product_name}库存为${n.value.inventory_num}`):Promise.resolve(),trigger:["blur","change"]}],loss_date:[{required:!0,message:"请选择报损日期",trigger:["change"]}]}),E=ie(()=>[{title:"商品名称",dataIndex:"product_name",key:"product_name",sorter:!0,ellipsis:!0,fixed:"left",width:200},{title:"商品规格",dataIndex:"product_spec",key:"product_spec",sorter:!0,ellipsis:!0,width:120},{title:"报损数量",dataIndex:"loss_num",key:"loss_num",sorter:!0,ellipsis:!0,width:120},{title:"库存单位成本",dataIndex:"lossUnitCost",key:"lossUnitCost",sorter:!0,ellipsis:!0,width:150,customRender:t=>{var e;return((e=t.record.lossUnitCost)==null?void 0:e.toFixed(2))||"0.00"}},{title:"报损总成本",dataIndex:"losstotal_cost",key:"losstotal_cost",sorter:!0,ellipsis:!0,width:150,customRender:t=>{var e;return((e=t.record.losstotal_cost)==null?void 0:e.toFixed(2))||"0.00"}},{title:"报损日期",dataIndex:"loss_date",key:"loss_date",sorter:!0,ellipsis:!0,width:120},{title:"报损原因",dataIndex:"loss_reason",key:"loss_reason",ellipsis:!0,width:150,customRender:t=>t.record.loss_reason||"-"},{title:"操作",key:"action",fixed:"right",width:120,customRender:({record:t})=>M("div",[M("span",{style:{display:"inline-block",padding:"2px 8px",backgroundColor:"#ff4d4f",color:"#fff",borderRadius:"2px",cursor:"pointer",fontSize:"12px"},onClick:()=>W(t.id)},"删")])}]),_=async t=>{var e,r;Y.value=!0;try{const m={...i,start_date:c.value[0]?typeof((e=c.value[0])==null?void 0:e.format)=="function"?c.value[0].format("YYYY-MM-DD"):c.value[0]:void 0,end_date:c.value[1]?typeof((r=c.value[1])==null?void 0:r.format)=="function"?c.value[1].format("YYYY-MM-DD"):c.value[1]:void 0,...t&&{id:t}},u=await Ye(m);$.value=u.data.list.map(y=>({...y,lossUnitCost:y.lossUnitCost||0,losstotal_cost:y.losstotal_cost||0})),C.value=u.data.total}catch(m){console.error("获取库存报损列表失败:",m),x.error("获取数据失败，请稍后重试")}finally{Y.value=!1}},T=t=>{i.page_num=t,_()},X=(t,e)=>{i.page_size=e,i.page_num=1,_()},G=()=>{i.page_num=1,i.page_size=10,i.product_name="",D.value="",c.value=[],_()},A=async t=>{if(t)try{const e=await R({product_name:t,page_size:5});Array.isArray(e.data.list)?v.value=e.data.list.map(r=>({label:r.product_name,value:r.product_name})):v.value=[]}catch(e){console.error("获取商品列表失败:",e),v.value=[]}},O=async()=>{try{const t=await R({page_size:5});Array.isArray(t.data.list)&&(v.value=t.data.list.map(e=>({label:e.product_name,value:e.product_name})))}catch(t){console.error("获取商品列表失败:",t)}},H=async t=>{if(!t){n.value=null,p.value="";return}try{const e=await R({product_name:t,page_size:1});Array.isArray(e.data.list)&&e.data.list.length>0?(n.value=e.data.list[0],p.value="",n.value&&s.loss_num>n.value.inventory_num&&(p.value=`库存不足，当前${t}库存为${n.value.inventory_num}`)):(n.value=null,p.value="商品不存在")}catch(e){console.error("获取商品库存失败:",e),n.value=null}},J=()=>{Object.assign(s,{id:void 0,product_name:"",product_spec:"",loss_num:1,loss_date:U(),loss_reason:""}),n.value=null,p.value="",S.value="新建库存报损",g.value=!0},K=async()=>{if(z.value)try{if(await z.value.validate(),n.value&&s.loss_num>n.value.inventory_num){x.error(`库存不足，当前${s.product_name}库存为${n.value.inventory_num}`);return}const t={...s,loss_date:typeof s.loss_date=="object"&&s.loss_date!==null&&typeof s.loss_date.format=="function"?s.loss_date.format("YYYY-MM-DD"):void 0};await ze(t),x.success("报损成功，已自动扣减库存"),g.value=!1,_()}catch(t){console.error("提交失败:",t),t.errorFields?x.error("请检查表单填写是否正确"):k.error({title:"操作失败",content:t.message||"服务器错误，请稍后重试"})}},Q=()=>{s.id||(Object.assign(s,{product_name:"",product_spec:"",loss_num:1,loss_date:U(),loss_reason:""}),n.value=null,p.value="")},W=t=>{k.confirm({title:"确认删除",icon:()=>M(Ce),content:"删除后将恢复库存，是否确认删除？",okText:"确认",cancelText:"取消",onOk:async()=>{try{await De({id:t}),x.success("删除成功，已恢复库存"),_()}catch(e){console.error("删除失败:",e),k.error({title:"删除失败",content:e.message||"服务器错误，请稍后重试"})}}})};return re(async()=>{await O();const t=V.query.id;t?_(Number(t)):_()}),(t,e)=>{const r=de,m=ge,u=he,y=ye,j=xe,B=ce,Z=pe,ee=_e,te=me,oe=be,ae=ke,se=we,le=k;return h(),I("div",Ue,[e[19]||(e[19]=q("h1",null,"库存报损录入/查询",-1)),q("div",Ie,[o(r,{type:"primary",onClick:J},{icon:l(()=>[o(ve(fe))]),default:l(()=>[e[12]||(e[12]=f(" 新建库存报损 ",-1))]),_:1})]),w.value?(h(),F(B,{key:0,model:i,layout:"inline",style:{"margin-bottom":"16px",padding:"16px",background:"#fafafa","border-radius":"8px"}},{default:l(()=>[o(u,{label:"商品名称"},{default:l(()=>[o(m,{value:i.product_name,"onUpdate:value":e[0]||(e[0]=a=>i.product_name=a),placeholder:"请输入商品名称","show-search":"","filter-option":!1,options:v.value,onSearch:A,style:{width:"200px"}},null,8,["value","options"])]),_:1}),o(u,{label:"报损日期范围"},{default:l(()=>[o(y,{value:c.value,"onUpdate:value":e[1]||(e[1]=a=>c.value=a),format:"YYYY-MM-DD",style:{width:"300px"}},null,8,["value"])]),_:1}),o(u,{label:"报损原因"},{default:l(()=>[o(j,{value:D.value,"onUpdate:value":e[2]||(e[2]=a=>D.value=a),placeholder:"请输入报损原因",style:{width:"200px"}},null,8,["value"])]),_:1}),o(u,null,{default:l(()=>[o(r,{type:"primary",onClick:e[3]||(e[3]=()=>_())},{default:l(()=>[...e[13]||(e[13]=[f("查询",-1)])]),_:1}),o(r,{style:{"margin-left":"8px"},onClick:G},{default:l(()=>[...e[14]||(e[14]=[f("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])):b("",!0),o(Z,{checked:w.value,"onUpdate:checked":e[4]||(e[4]=a=>w.value=a),style:{"margin-bottom":"16px"}},{default:l(()=>[...e[15]||(e[15]=[f("显示搜索栏",-1)])]),_:1},8,["checked"]),o(ee,{columns:E.value,"data-source":$.value,"row-key":a=>a.id,pagination:!1,scroll:{x:1400},loading:Y.value},null,8,["columns","data-source","row-key","loading"]),C.value>0?(h(),F(te,{key:1,current:i.page_num,"page-size":i.page_size,total:C.value,"show-size-changer":"","show-total":a=>`共 ${a} 条记录`,style:{"margin-top":"24px","text-align":"right"},onChange:T,onShowSizeChange:X},null,8,["current","page-size","total","show-total"])):b("",!0),o(le,{open:g.value,"onUpdate:open":e[11]||(e[11]=a=>g.value=a),title:S.value,width:"600px",destroyOnClose:"",footer:null},{default:l(()=>[o(B,{ref_key:"formRef",ref:z,model:s,rules:N,layout:"vertical"},{default:l(()=>[o(u,{label:"商品名称",name:"product_name"},{default:l(()=>[o(m,{value:s.product_name,"onUpdate:value":e[5]||(e[5]=a=>s.product_name=a),placeholder:"请选择商品","show-search":"","filter-option":!1,options:v.value,onSearch:A,onFocus:O,onChange:H,style:{width:"100%"}},null,8,["value","options"]),n.value?(h(),I("div",Me," 当前库存："+L(n.value.inventory_num),1)):b("",!0)]),_:1}),o(u,{label:"商品规格",name:"product_spec"},{default:l(()=>[o(j,{value:s.product_spec,"onUpdate:value":e[6]||(e[6]=a=>s.product_spec=a),placeholder:"请输入商品规格，例如：30",style:{width:"100%"}},null,8,["value"])]),_:1}),o(u,{label:"报损数量",name:"loss_num"},{default:l(()=>[o(oe,{value:s.loss_num,"onUpdate:value":e[7]||(e[7]=a=>s.loss_num=a),min:1,step:1,precision:0,placeholder:"请输入报损数量",style:{width:"100%"}},null,8,["value"]),p.value?(h(),I("div",Re,L(p.value),1)):b("",!0)]),_:1}),o(u,{label:"报损日期",name:"loss_date"},{default:l(()=>[o(ae,{value:s.loss_date,"onUpdate:value":e[8]||(e[8]=a=>s.loss_date=a),format:"YYYY-MM-DD",style:{width:"100%"}},null,8,["value"])]),_:1}),o(u,{label:"报损原因",name:"loss_reason"},{default:l(()=>[o(se,{value:s.loss_reason,"onUpdate:value":e[9]||(e[9]=a=>s.loss_reason=a),rows:4,maxLength:200,placeholder:"请输入报损原因（如：损坏/过期/丢失）","show-word-limit":""},null,8,["value"])]),_:1}),o(u,{style:{"margin-top":"24px"}},{default:l(()=>[o(r,{type:"primary",onClick:K},{default:l(()=>[...e[16]||(e[16]=[f("提交",-1)])]),_:1}),o(r,{style:{"margin-left":"8px"},onClick:Q},{default:l(()=>[...e[17]||(e[17]=[f("重置",-1)])]),_:1}),o(r,{style:{"margin-left":"8px"},onClick:e[10]||(e[10]=a=>g.value=!1)},{default:l(()=>[...e[18]||(e[18]=[f("取消",-1)])]),_:1})]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["open","title"])])}}}),qe=Pe(Se,[["__scopeId","data-v-6de39efd"]]);export{qe as default};
