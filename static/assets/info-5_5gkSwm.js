import{d as te,ae as I,I as f,O as re,c as oe,h as se,a as r,f as n,e as ne,s as le,b as d,u as ue,U as ce,V as k,B as ie,ar as de,an as pe,ax as me,aj as v,o as q,ac as g,i as _e,ay as fe,az as ge,at as ye,as as ve,aA as he,aB as be,av as ke,aC as x,aD as xe,aE as we}from"./.pnpm-B0XLMEKp.js";import{g as D,a as Se,b as Ce,u as Ie,c as De,d as Pe}from"./sale-4Bf2RFfJ.js";import{i as A}from"./basic-Com0UItg.js";import{r as Re}from"./request-DINYhP-L.js";import{_ as Ue}from"./index-CnvvL9sG.js";const ze={class:"page-container"},Oe=te({__name:"info",setup(Ye){const y=d(!1),P=d("新增销售信息"),w=d(!0),h=d([]),p=d([]),_=d([]),R=d([]),M=d(0),S=d(!1),B=ue(),l=I({page_num:1,page_size:10}),t=I({purchaser_name:"",product_name:"",product_spec:"",customer_product_name:"",sale_num:0,sale_price:0,sale_date:f(),remark:""}),j=I({purchaser_name:[{required:!0,message:"请选择采购商",trigger:["change"]}],product_name:[{required:!0,message:"请输入商品名称",trigger:["blur","change"]}],product_spec:[{required:!0,message:"请输入商品规格",trigger:["blur","change"]}],sale_num:[{required:!0,message:"请输入销售数量",trigger:["blur","change"]},{type:"number",min:1,message:"销售数量必须为正整数",trigger:["blur","change"]}],sale_price:[{required:!0,message:"请输入销售单价",trigger:["blur","change"]},{type:"number",min:.01,message:"销售单价必须为正数",trigger:["blur","change"]}],sale_date:[{required:!0,message:"请选择销售日期",trigger:["change"]}]}),T=ce(()=>[{title:"采购商名称",dataIndex:"purchaser_name",key:"purchaser_name",sorter:!0,ellipsis:!0},{title:"商品名称",dataIndex:"product_name",key:"product_name",sorter:!0,ellipsis:!0},{title:"商品规格",dataIndex:"product_spec",key:"product_spec",sorter:!0,ellipsis:!0},{title:"客户侧商品名",dataIndex:"customer_product_name",key:"customer_product_name",sorter:!0,ellipsis:!0},{title:"销售数量",dataIndex:"sale_num",key:"sale_num",sorter:!0,ellipsis:!0},{title:"销售单价",dataIndex:"sale_price",key:"sale_price",sorter:!0,ellipsis:!0,customRender:a=>a.record.sale_price.toFixed(2)},{title:"销售总价",dataIndex:"total_price",key:"total_price",sorter:!0,ellipsis:!0,customRender:a=>a.record.total_price.toFixed(2)},{title:"商品单位利润",dataIndex:"unit_profit",key:"unit_profit",sorter:!0,ellipsis:!0,customRender:a=>a.record.unit_profit.toFixed(2)},{title:"商品总利润",dataIndex:"total_profit",key:"total_profit",sorter:!0,ellipsis:!0,customRender:a=>a.record.total_profit.toFixed(2)},{title:"销售日期",dataIndex:"sale_date",key:"sale_date",sorter:!0,ellipsis:!0},{title:"备注",dataIndex:"remark",key:"remark",ellipsis:!0,customRender:a=>{const e=a.record.remark;if(!e)return"-";const o=e.length>4?e.substring(0,4)+"...":e;return x(xe,{title:e},{default:()=>o})}},{title:"操作",key:"action",fixed:"right",width:80,customRender:({record:a})=>x("div",[x("span",{style:{display:"inline-block",padding:"2px 8px",backgroundColor:"#ff4d4f",color:"#fff",borderRadius:"2px",cursor:"pointer",fontSize:"12px"},onClick:()=>W(a.id)},"删")])}]),i=async a=>{S.value=!0;try{const e={...l,...typeof a=="number"&&{id:a}},o=await Se(e);R.value=o.data.list,M.value=o.data.total}catch(e){console.error("获取销售信息列表失败:",e),k.error("获取数据失败，请稍后重试")}finally{S.value=!1}},V=a=>{l.page_num=a,i()},F=(a,e)=>{l.page_size=e,l.page_num=1,i()},N=()=>{l.page_num=1,l.page_size=10,l.purchaser_name="",l.product_name="",l.customer_product_name="",_.value=[],i()},U=async a=>{if(a)try{const e=await A({keyword:a});h.value=e.data.map(o=>({label:o,value:o}))}catch(e){console.error("获取采购商列表失败:",e)}},$=async a=>{a&&t.product_name&&await z(a,t.product_name)},L=async a=>{if(!a){p.value=[];return}try{const e=await D({keyword:a});Array.isArray(e.data)?p.value=e.data.map(o=>({label:o,value:o})):p.value=[]}catch(e){console.error("获取商品列表失败:",e),p.value=[]}},E=async a=>{a&&t.purchaser_name&&await z(t.purchaser_name,a)},G=async a=>{if(a)try{const e=await D({keyword:a});Array.isArray(e.data)?_.value=e.data.map(o=>({label:o,value:o})):_.value=[]}catch(e){console.error("获取商品列表失败:",e),_.value=[]}},z=async(a,e)=>{try{const u=(await Ce({purchaser_name:a,product_name:e})).data;u&&(u.sale_price&&(t.sale_price=u.sale_price),u.customer_product_name&&(t.customer_product_name=u.customer_product_name),u.product_spec&&(t.product_spec=u.product_spec))}catch(o){console.error("获取历史单价失败:",o)}},H=()=>{Object.assign(t,{id:void 0,purchaser_name:"",product_name:"",product_spec:"",customer_product_name:"",sale_num:0,sale_price:0,sale_date:f(),remark:""}),P.value="新增销售信息",y.value=!0},J=async(a,e)=>{var o;try{const c=((o=(await Re({url:"/sale/bill/list",method:"get",params:{purchaser_name:a,page_num:1,page_size:100}})).data)==null?void 0:o.list)||[];for(const m of c)if(m.end_date){const b=f(m.start_date),C=f(m.end_date);if(e.isAfter(b.subtract(1,"day"))&&e.isBefore(C.add(1,"day")))return{inRange:!0,bill:m}}return{inRange:!1}}catch(u){return console.error("检查对账单日期范围失败:",u),{inRange:!1}}},O=async()=>{const a={...t,sale_date:typeof t.sale_date=="object"&&t.sale_date!==null&&typeof t.sale_date.format=="function"?t.sale_date.format("YYYY-MM-DD"):void 0};t.id?(await Ie(a),k.success("操作成功"),y.value=!1,i()):(await De(a),k.success("操作成功"),y.value=!1,i())},K=async()=>{try{const a=f.isDayjs(t.sale_date)?t.sale_date:f(t.sale_date);if(t.purchaser_name){const e=await J(t.purchaser_name,a);if(e.inRange){v.confirm({title:"日期范围提醒",content:`您选择的销售日期(${a.format("YYYY-MM-DD")})在已确定的对账单日期范围内(${e.bill.start_date} 至 ${e.bill.end_date})。继续添加可能会导致对账单发生改变，确定要继续吗？`,onOk:async()=>{await O()}});return}}await O()}catch(a){console.error("提交失败:",a),v.error({title:"操作失败",content:a.message||"服务器错误，请稍后重试"})}},Q=()=>{t.id||Object.assign(t,{purchaser_name:"",product_name:"",product_spec:"",customer_product_name:"",sale_num:0,sale_price:0,sale_date:f(),remark:""})},W=a=>{v.confirm({title:"确认删除",icon:()=>x(we),content:"删除后同步更新对账单、库存及利润，不可恢复",okText:"确认",cancelText:"取消",onOk:async()=>{try{await Pe({id:a}),k.success("删除成功"),i()}catch(e){console.error("删除失败:",e),v.error({title:"删除失败",content:e.message||"服务器错误，请稍后重试"})}}})};return re(async()=>{await Promise.all([(async()=>{try{const e=await A();h.value=e.data.map(o=>({label:o,value:o}))}catch(e){console.error("获取采购商列表失败:",e)}})(),(async()=>{try{const e=await D({});Array.isArray(e.data)?(p.value=e.data.map(o=>({label:o,value:o})),_.value=p.value):(p.value=[],_.value=[])}catch(e){console.error("获取商品列表失败:",e)}})()]);const a=B.query.id;a?i(Number(a)):i()}),(a,e)=>{const o=ie,u=ge,c=ve,m=ye,b=de,C=pe,X=me,Y=he,Z=be,ee=ke,ae=v;return q(),oe("div",ze,[e[21]||(e[21]=se("h1",null,"销售信息录入/查询",-1)),r(o,{type:"primary",style:{"margin-bottom":"16px"},onClick:H},{icon:n(()=>[r(_e(fe))]),default:n(()=>[e[14]||(e[14]=g(" 新增销售信息 ",-1))]),_:1}),w.value?(q(),ne(b,{key:0,model:l,layout:"inline",style:{"margin-bottom":"16px"}},{default:n(()=>[r(c,{label:"采购商名称"},{default:n(()=>[r(u,{value:l.purchaser_name,"onUpdate:value":e[0]||(e[0]=s=>l.purchaser_name=s),placeholder:"请选择采购商","show-search":"","filter-option":!1,options:h.value,onSearch:U,style:{width:"200px"}},null,8,["value","options"])]),_:1}),r(c,{label:"商品名称"},{default:n(()=>[r(u,{value:l.product_name,"onUpdate:value":e[1]||(e[1]=s=>l.product_name=s),placeholder:"请输入商品名称","show-search":"","filter-option":!1,options:_.value,onSearch:G,style:{width:"200px"}},null,8,["value","options"])]),_:1}),r(c,{label:"客户侧商品名"},{default:n(()=>[r(m,{value:l.customer_product_name,"onUpdate:value":e[2]||(e[2]=s=>l.customer_product_name=s),placeholder:"请输入客户侧商品名",style:{width:"200px"}},null,8,["value"])]),_:1}),r(c,null,{default:n(()=>[r(o,{type:"primary",onClick:i},{default:n(()=>[...e[15]||(e[15]=[g("查询",-1)])]),_:1}),r(o,{style:{"margin-left":"8px"},onClick:N},{default:n(()=>[...e[16]||(e[16]=[g("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])):le("",!0),r(C,{checked:w.value,"onUpdate:checked":e[3]||(e[3]=s=>w.value=s),style:{"margin-bottom":"16px"}},{default:n(()=>[...e[17]||(e[17]=[g("显示搜索栏",-1)])]),_:1},8,["checked"]),r(X,{columns:T.value,"data-source":R.value,"row-key":s=>s.id,pagination:{showSizeChanger:!0,pageSizeOptions:["10","20","50","100"],showTotal:s=>`共 ${s} 条记录`,current:l.page_num,pageSize:l.page_size,onChange:V,onShowSizeChange:F},scroll:{x:1600},loading:S.value},null,8,["columns","data-source","row-key","pagination","loading"]),r(ae,{open:y.value,"onUpdate:open":e[13]||(e[13]=s=>y.value=s),title:P.value,width:"600px",destroyOnClose:"",footer:null},{default:n(()=>[r(b,{model:t,rules:j,layout:"vertical"},{default:n(()=>[r(c,{label:"采购商名称",name:"purchaser_name"},{default:n(()=>[r(u,{value:t.purchaser_name,"onUpdate:value":e[4]||(e[4]=s=>t.purchaser_name=s),placeholder:"请选择采购商","show-search":"","filter-option":!1,options:h.value,onSearch:U,onChange:$},null,8,["value","options"])]),_:1}),r(c,{label:"商品名称",name:"product_name"},{default:n(()=>[r(u,{value:t.product_name,"onUpdate:value":e[5]||(e[5]=s=>t.product_name=s),options:p.value,placeholder:"请输入商品名称","show-search":"","filter-option":!1,onSearch:L,onChange:E,style:{width:"100%"}},null,8,["value","options"])]),_:1}),r(c,{label:"商品规格",name:"product_spec"},{default:n(()=>[r(m,{value:t.product_spec,"onUpdate:value":e[6]||(e[6]=s=>t.product_spec=s),placeholder:"请输入商品规格，例如：30"},null,8,["value"])]),_:1}),r(c,{label:"客户侧商品名",name:"customer_product_name"},{default:n(()=>[r(m,{value:t.customer_product_name,"onUpdate:value":e[7]||(e[7]=s=>t.customer_product_name=s),placeholder:"请输入客户侧商品名"},null,8,["value"])]),_:1}),r(c,{label:"销售数量",name:"sale_num"},{default:n(()=>[r(Y,{value:t.sale_num,"onUpdate:value":e[8]||(e[8]=s=>t.sale_num=s),min:1,step:1,precision:0,placeholder:"请输入销售数量"},null,8,["value"])]),_:1}),r(c,{label:"销售单价",name:"sale_price"},{default:n(()=>[r(Y,{value:t.sale_price,"onUpdate:value":e[9]||(e[9]=s=>t.sale_price=s),min:.01,step:.01,precision:2,placeholder:"请输入销售单价"},null,8,["value"])]),_:1}),r(c,{label:"销售日期",name:"sale_date"},{default:n(()=>[r(Z,{value:t.sale_date,"onUpdate:value":e[10]||(e[10]=s=>t.sale_date=s),format:"YYYY-MM-DD",style:{width:"100%"}},null,8,["value"])]),_:1}),r(c,{label:"备注",name:"remark"},{default:n(()=>[r(ee,{value:t.remark,"onUpdate:value":e[11]||(e[11]=s=>t.remark=s),rows:4,maxLength:200,placeholder:"请输入备注信息"},null,8,["value"])]),_:1}),r(c,{style:{"margin-top":"24px"}},{default:n(()=>[r(o,{type:"primary",onClick:K},{default:n(()=>[...e[18]||(e[18]=[g("提交",-1)])]),_:1}),r(o,{style:{"margin-left":"8px"},onClick:Q},{default:n(()=>[...e[19]||(e[19]=[g("重置",-1)])]),_:1}),r(o,{style:{"margin-left":"8px"},onClick:e[12]||(e[12]=s=>y.value=!1)},{default:n(()=>[...e[20]||(e[20]=[g("取消",-1)])]),_:1})]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["open","title"])])}}}),Te=Ue(Oe,[["__scopeId","data-v-3112584a"]]);export{Te as default};
