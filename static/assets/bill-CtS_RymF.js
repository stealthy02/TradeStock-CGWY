import{ae as A,I as w,O as Te,o as b,c as P,h as i,e as E,f as o,a as l,az as qe,aF as He,ac as m,aG as Ge,aA as Je,B as Ke,s as le,t as _,F as Qe,ax as We,ar as Xe,as as Ze,aB as et,av as tt,b as r,V as d,an as at,aC as g,ai as nt,aj as lt,ap as L}from"./.pnpm-B0XLMEKp.js";import{e as ot,f as rt,h as ut,i as it,j as st}from"./sale-4Bf2RFfJ.js";import{r as h}from"./request-DINYhP-L.js";import{_ as dt}from"./index-CnvvL9sG.js";const ct={class:"page-container"},vt={key:0},mt={style:{"margin-bottom":"16px","padding-bottom":"16px","border-bottom":"1px solid #f0f0f0"}},pt={style:{"margin-top":"16px"}},ft={style:{"margin-bottom":"24px"}},_t={key:0,style:{color:"#ff4d4f","font-size":"12px","margin-top":"4px"}},yt={class:"modal-footer"},gt={__name:"bill",setup(kt){const j=r(!0),N=r([]),s=A({page_num:1,page_size:10,purchaser_name:void 0,receive_status:void 0,invoice_status:void 0,min_amount:void 0,max_amount:void 0}),T=r([]),ce=r(0),q=r(!1),H=r(!1),n=r(null),G=r([]),J=r([]),K=r(!1),Q=r(1),oe=r(10),D=r(!1),W=r(null),v=A({bill_id:void 0,receive_date:w(),receive_amount:void 0,receive_method:void 0,remark:""}),X=r(""),F=r([{label:"微信",value:"微信"},{label:"支付宝",value:"支付宝"},{label:"银行卡",value:"银行卡"},{label:"现金",value:"现金"}]),ve=A({receive_date:[{required:!0,message:"请选择收款日期",trigger:"change"}],receive_amount:[{required:!0,message:"请输入收款金额",trigger:"blur",type:"number"},{type:"number",min:.01,message:"收款金额必须为正数",trigger:"blur"}],receive_method:[{required:!0,message:"请选择收款方式",trigger:"change"}]}),R=r(!1),Z=r("修改开票状态"),ee=r(""),M=A({bill_id:void 0,invoice_status:0}),Y=r(!1),re=r(""),te=r(void 0),I=r(!1),$=r(void 0),z=r(!1),me=r(""),ue=r(void 0),U=r(!1),ie=r(""),ae=r(void 0),p=r(null),O=r(null),B=r(null),pe=[{title:"采购商名称",dataIndex:"purchaser_name",key:"purchaser_name",sorter:!0,ellipsis:!0},{title:"起始日期",dataIndex:"start_date",key:"start_date",sorter:!0,ellipsis:!0,customRender:function(t){return t.record.start_date||"-"}},{title:"结束日期",dataIndex:"end_date",key:"end_date",sorter:!0,ellipsis:!0,customRender:function(t){return t.record.end_date||"未确定"}},{title:"对账金额",dataIndex:"statement_amount",key:"statement_amount",sorter:!0,ellipsis:!0,customRender:function(t){return t.record.statement_amount?t.record.statement_amount.toFixed(2):"0.00"}},{title:"已收金额",dataIndex:"received_amount",key:"received_amount",sorter:!0,ellipsis:!0,customRender:function(t){return t.record.received_amount?t.record.received_amount.toFixed(2):"0.00"}},{title:"未收金额",dataIndex:"unreceived_amount",key:"unreceived_amount",sorter:!0,ellipsis:!0,customRender:function(t){return t.record.unreceived_amount?t.record.unreceived_amount.toFixed(2):"0.00"}},{title:"结款状态",dataIndex:"receive_status",key:"receive_status",sorter:!0,ellipsis:!0,customRender:function(t){return t.record.receive_status===1?g(L,{color:"success"},()=>"已结清"):g(L,{color:"error"},()=>"未结清")}},{title:"开票状态",dataIndex:"invoice_status",key:"invoice_status",sorter:!0,ellipsis:!0,customRender:function(t){return t.record.invoice_status===1?g(L,{color:"blue"},()=>"已开票"):g(L,{color:"default"},()=>"未开票")}},{title:"操作",key:"action",fixed:"right",width:200,customRender:function(t){const e=t.record,u=!!e.end_date;return g("div",[g("span",{style:{display:"inline-block",marginRight:"8px",cursor:"pointer",color:"#1890ff"},onClick:()=>Pe(e)},"查看细则"),g("span",{style:{display:"inline-block",marginRight:"8px",cursor:"pointer",color:"#1890ff",opacity:!u||e.receive_status===1?.5:1,pointerEvents:!u||e.receive_status===1?"none":"auto"},onClick:()=>ke(e)},"录入收款"),g("span",{style:{display:"inline-block",cursor:"pointer",color:"#1890ff",opacity:u?1:.5,pointerEvents:u?"auto":"none"},onClick:()=>we(e)},"修改开票状态")])}}],fe=[{title:"商品名称",dataIndex:"product_name",key:"product_name",ellipsis:!0},{title:"客户商品名称",dataIndex:"customer_product_name",key:"customer_product_name",ellipsis:!0,customRender:function(t){return t.record.customer_product_name||"-"}},{title:"销售日期",dataIndex:"sale_date",key:"sale_date",ellipsis:!0},{title:"总公斤数",dataIndex:"total_kg",key:"total_kg",ellipsis:!0},{title:"单价",dataIndex:"unit_price",key:"unit_price",ellipsis:!0,customRender:function(t){return t.record.unit_price?t.record.unit_price.toFixed(2):"0.00"}},{title:"销售总价",dataIndex:"total_price",key:"total_price",ellipsis:!0,customRender:function(t){return t.record.total_price?t.record.total_price.toFixed(2):"0.00"}},{title:"备注",dataIndex:"remark",key:"remark",ellipsis:!0,customRender:function(t){return t.record.remark||"-"}}],_e=[{title:"收款日期",dataIndex:"receiptDate",key:"receiptDate",ellipsis:!0},{title:"收款金额",dataIndex:"receiptAmount",key:"receiptAmount",ellipsis:!0,customRender:function(t){return t.record.receiptAmount?t.record.receiptAmount.toFixed(2):"0.00"}},{title:"收款方式",dataIndex:"receiptMethod",key:"receiptMethod",ellipsis:!0},{title:"备注",dataIndex:"remark",key:"remark",ellipsis:!0,customRender:function(t){return t.record.remark||"-"}},{title:"操作",key:"action",fixed:"right",width:100,customRender:function(t){const e=t.record;return g("span",{style:{display:"inline-block",cursor:"pointer",color:"#ff4d4f"},onClick:()=>Se(e)},"删除")}}],ye=t=>{Q.value=t,n.value&&k(n.value.id,n.value.purchaser_id)},ge=(t,e)=>{oe.value=e,Q.value=1,n.value&&k(n.value.id,n.value.purchaser_id)},ke=t=>{if(t.receive_status===1){d.warning("该对账单已全部结清，无需再次收款");return}v.bill_id=t.id,v.receive_date=w(),v.receive_amount=void 0,v.receive_method=void 0,v.remark="",X.value="",D.value=!0},xe=t=>{if(!t)return;F.value.some(u=>u.value===t)||(F.value=[{label:t,value:t},...F.value])},be=t=>{v.receive_method=t},he=async()=>{if(W.value)try{if(await W.value.validate(),n.value&&v.receive_amount&&v.receive_amount>n.value.unreceived_amount){const u=n.value.unreceived_amount?n.value.unreceived_amount.toFixed(2):"0.00";d.error(`收款金额不可超过未收金额${u}元`);return}const t={...v,receive_date:w.isDayjs(v.receive_date)?v.receive_date.format("YYYY-MM-DD"):v.receive_date},e=await ut(t);d.success("收款成功！"),e.data.pay_status===1&&d.success("该对账单已全部结清"),D.value=!1,f(),n.value&&k(n.value.id,n.value.purchaser_id)}catch(t){console.error("提交收款失败:",t),d.error("提交失败，请稍后重试")}},we=t=>{M.bill_id=t.id,t.invoice_status===0?(Z.value="标记为已开票",ee.value=`确定将${t.purchaser_name}的销售对账单标记为已开票吗？`,M.invoice_status=1):(Z.value="标记为未开票",ee.value=`确定将${t.purchaser_name}的销售对账单标记为未开票吗？`,M.invoice_status=0),R.value=!0},Ce=async()=>{if(M.bill_id)try{await st(M),d.success("开票状态更新成功"),R.value=!1,f()}catch(t){console.error("更新开票状态失败:",t),d.error("更新失败，请稍后重试")}},Se=t=>{te.value=t.id;const e=t.receiptAmount?t.receiptAmount.toFixed(2):"0.00";re.value=`确定要删除这条收款记录吗？收款金额：${e}元，收款日期：${t.receiptDate}`,Y.value=!0},De=async()=>{if(te.value)try{await h({url:"/sale/bill/receive/delete",method:"delete",params:{receive_id:te.value}}),d.success("收款记录删除成功"),Y.value=!1,n.value&&await k(n.value.id,n.value.purchaser_id),f()}catch(t){console.error("删除收款记录失败:",t),d.error("删除失败，请稍后重试")}},f=async()=>{q.value=!0;try{const t=await ot(s);T.value=t.data.list,ce.value=t.data.total}catch(t){console.error("获取销售对账单列表失败:",t),d.error("获取数据失败，请稍后重试")}finally{q.value=!1}},Re=t=>{s.page_num=t,f()},Me=(t,e)=>{s.page_size=e,s.page_num=1,f()},Ye=()=>{s.page_num=1,s.page_size=10,s.purchaser_name=void 0,s.receive_status=void 0,s.invoice_status=void 0,s.min_amount=void 0,s.max_amount=void 0,f()},Ie=()=>{d.info("请在细则中点击导出按钮")},Ue=async()=>{if(!n.value){d.error("请先选择对账单");return}try{const t={bill_id:n.value.id};p.value&&(t.end_date=p.value.format("YYYY-MM-DD"));const e=await rt(t),u=window.URL.createObjectURL(e),c=document.createElement("a");c.href=u;const y=`销售对账单_${n.value.purchaser_name}_${w().format("YYYYMMDDHHmmss")}.xlsx`;c.download=y,document.body.appendChild(c),c.click(),document.body.removeChild(c),window.URL.revokeObjectURL(u),d.success("导出成功")}catch(t){console.error("导出失败:",t),d.error("导出失败，请稍后重试")}},Fe=async t=>{if(t)try{const e=await h({url:"/basic/purchaser/select",method:"get",params:{keyword:t}});N.value=e.data.map(u=>({label:u.purchaser_name,value:u.purchaser_name}))}catch(e){console.error("获取采购商列表失败:",e)}},$e=t=>{if(!p.value){d.warning("请先在细则中选择对账结束日期");return}$.value=t.id,I.value=!0},ze=t=>{if(!n.value||!n.value.start_date)return!1;const e=w(n.value.start_date);return t&&t<e},Oe=async t=>{!t||!n.value||(p.value=t,await k(n.value.id,n.value.purchaser_id))},Be=async()=>{if(ue.value)try{const t=await h({url:"/sale/statement/delete",method:"delete",params:{statement_id:ue.value}});d.success("对账单删除成功"),z.value=!1,f()}catch(t){console.error("删除对账单失败:",t),d.error("删除失败，请稍后重试")}},Ve=t=>{t.end_date&&(ae.value=t.id,ie.value="确定要取消确认此对账单吗？取消后，该对账单的结束日期将被设为未确定，对应的销售记录将可以重新编辑。",U.value=!0)},Ae=async()=>{if(ae.value)try{const t=await h({url:"/sale/statement/unconfirm",method:"post",params:{statement_id:ae.value}});d.success("对账单取消确认成功"),U.value=!1,f(),n.value&&await k(n.value.id,n.value.purchaser_id)}catch(t){console.error("取消确认对账单失败:",t),d.error("取消确认失败，请稍后重试")}},Pe=async t=>{n.value=t,H.value=!0,p.value=w(),O.value=null,B.value=null,await k(t.id,t.purchaser_id)},k=async(t,e)=>{K.value=!0;try{const u={bill_id:t};t===0&&e&&(u.purchaser_id=e),p.value&&(u.end_date=p.value.format("YYYY-MM-DD"));const c=await it(u);G.value=c.data.sale_list.list,J.value=c.data.receipt_list.list,c.data.bill_info&&(n.value=c.data.bill_info,O.value=c.data.bill_info.statement_amount,B.value=c.data.bill_info.unreceived_amount)}catch(u){console.error("获取销售对账单细则失败:",u),d.error("获取细则失败，请稍后重试"),G.value=[],J.value=[]}finally{K.value=!1}},Ee=async()=>{if($.value)try{const t=w.isDayjs(p.value)?p.value.format("YYYY-MM-DD"):p.value;let e;if($.value===0){const u=n.value.purchaser_name;if(!u){d.error("无法获取采购商信息，请稍后重试");return}const y=(await h({url:"/sale/statement/last",method:"get",params:{purchaser_name:u}})).data.next_start_date||t;await h({url:"/sale/statement/create",method:"post",data:{purchaser_name:u,start_date:y}}),await f();const C=T.value.find(V=>V.purchaser_name===u&&!V.end_date);if(!C){d.error("无法找到新创建的对账单，请稍后重试");return}e={statement_id:C.id,end_date:t}}else e={statement_id:$.value,end_date:t};await h({url:"/sale/statement/confirm",method:"post",data:e}),d.success("对账单确认成功"),I.value=!1,f(),n.value&&await k(n.value.id,n.value.purchaser_id)}catch(t){console.error("确认对账单失败:",t),d.error("确认失败，请稍后重试")}};return Te(async()=>{await Promise.all([(async()=>{try{const t=await h({url:"/basic/purchaser/select",method:"get"});N.value=t.data.map(e=>({label:e.purchaser_name,value:e.purchaser_name}))}catch(t){console.error("获取采购商列表失败:",t)}})()]),f()}),(t,e)=>{const u=qe,c=Ze,y=He,C=Je,V=Ge,x=Ke,se=Xe,Le=at,ne=We,de=et,je=nt,Ne=tt,S=lt;return b(),P("div",ct,[e[52]||(e[52]=i("h1",null,"销售对账单管理",-1)),j.value?(b(),E(se,{key:0,model:s,layout:"inline",style:{"margin-bottom":"16px",padding:"16px",background:"#fafafa","border-radius":"8px"}},{default:o(()=>[l(c,{label:"采购商名称"},{default:o(()=>[l(u,{value:s.purchaser_name,"onUpdate:value":e[0]||(e[0]=a=>s.purchaser_name=a),placeholder:"请选择采购商","show-search":"","filter-option":!1,options:N.value,onSearch:Fe,style:{width:"200px"}},null,8,["value","options"])]),_:1}),l(c,{label:"结款状态"},{default:o(()=>[l(u,{value:s.receive_status,"onUpdate:value":e[1]||(e[1]=a=>s.receive_status=a),placeholder:"请选择结款状态",style:{width:"150px"}},{default:o(()=>[l(y,{value:""},{default:o(()=>[...e[26]||(e[26]=[m("全部",-1)])]),_:1}),l(y,{value:0},{default:o(()=>[...e[27]||(e[27]=[m("未结清",-1)])]),_:1}),l(y,{value:1},{default:o(()=>[...e[28]||(e[28]=[m("已结清",-1)])]),_:1})]),_:1},8,["value"])]),_:1}),l(c,{label:"开票状态"},{default:o(()=>[l(u,{value:s.invoice_status,"onUpdate:value":e[2]||(e[2]=a=>s.invoice_status=a),placeholder:"请选择开票状态",style:{width:"150px"}},{default:o(()=>[l(y,{value:""},{default:o(()=>[...e[29]||(e[29]=[m("全部",-1)])]),_:1}),l(y,{value:0},{default:o(()=>[...e[30]||(e[30]=[m("未开票",-1)])]),_:1}),l(y,{value:1},{default:o(()=>[...e[31]||(e[31]=[m("已开票",-1)])]),_:1})]),_:1},8,["value"])]),_:1}),l(c,{label:"对账金额范围"},{default:o(()=>[l(V,{compact:""},{default:o(()=>[l(C,{value:s.min_amount,"onUpdate:value":e[3]||(e[3]=a=>s.min_amount=a),placeholder:"最小",min:0,step:.01,precision:2,style:{width:"100px"}},null,8,["value"]),e[32]||(e[32]=i("span",{style:{margin:"0 8px"}},"-",-1)),l(C,{value:s.max_amount,"onUpdate:value":e[4]||(e[4]=a=>s.max_amount=a),placeholder:"最大",min:0,step:.01,precision:2,style:{width:"100px"}},null,8,["value"])]),_:1})]),_:1}),l(c,null,{default:o(()=>[l(x,{type:"primary",onClick:f},{default:o(()=>[...e[33]||(e[33]=[m("查询",-1)])]),_:1}),l(x,{style:{"margin-left":"8px"},onClick:Ye},{default:o(()=>[...e[34]||(e[34]=[m("重置",-1)])]),_:1}),l(x,{style:{"margin-left":"8px"},onClick:Ie},{default:o(()=>[...e[35]||(e[35]=[m("导出",-1)])]),_:1})]),_:1})]),_:1},8,["model"])):le("",!0),l(Le,{checked:j.value,"onUpdate:checked":e[5]||(e[5]=a=>j.value=a),style:{"margin-bottom":"16px"}},{default:o(()=>[...e[36]||(e[36]=[m("显示搜索栏",-1)])]),_:1},8,["checked"]),l(ne,{columns:pe,"data-source":T.value,"row-key":a=>a.id,pagination:{showSizeChanger:!0,pageSizeOptions:["10","20","50","100"],showTotal:a=>`共 ${a} 条记录`,current:s.page_num,pageSize:s.page_size,onChange:Re,onShowSizeChange:Me},scroll:{x:1200},loading:q.value},null,8,["data-source","row-key","pagination","loading"]),l(je,{title:"销售对账单细则",placement:"right",width:800,open:H.value,onClose:e[9]||(e[9]=a=>H.value=!1)},{extra:o(()=>[l(x,{type:"primary",onClick:Ue},{default:o(()=>[...e[37]||(e[37]=[m("导出",-1)])]),_:1})]),default:o(()=>[n.value?(b(),P("div",vt,[i("div",mt,[i("p",null,[e[38]||(e[38]=i("strong",null,"采购商名称：",-1)),m(_(n.value.purchaser_name||"-"),1)]),i("p",null,[e[39]||(e[39]=i("strong",null,"对账开始日期：",-1)),m(_(n.value.start_date||"-"),1)]),i("p",null,[e[40]||(e[40]=i("strong",null,"对账结束日期：",-1)),n.value.end_date?(b(),P(Qe,{key:1},[m(_(n.value.end_date),1)],64)):(b(),E(de,{key:0,value:p.value,"onUpdate:value":e[6]||(e[6]=a=>p.value=a),format:"YYYY-MM-DD",style:{width:"150px","margin-left":"8px"},"disabled-date":ze,onChange:Oe},null,8,["value"]))]),i("p",null,[e[41]||(e[41]=i("strong",null,"对账金额：",-1)),m(_(O.value?O.value.toFixed(2):n.value.statement_amount?n.value.statement_amount.toFixed(2):"0.00")+" 元",1)]),i("p",null,[e[42]||(e[42]=i("strong",null,"已收金额：",-1)),m(_(n.value.received_amount?n.value.received_amount.toFixed(2):"0.00")+" 元",1)]),i("p",null,[e[43]||(e[43]=i("strong",null,"未收金额：",-1)),m(_(B.value?B.value.toFixed(2):n.value.unreceived_amount?n.value.unreceived_amount.toFixed(2):"0.00")+" 元",1)]),i("div",pt,[n.value.end_date?(b(),E(x,{key:1,type:"default",onClick:e[8]||(e[8]=a=>Ve(n.value))},{default:o(()=>[...e[45]||(e[45]=[m(" 撤销确认 ",-1)])]),_:1})):(b(),E(x,{key:0,type:"primary",onClick:e[7]||(e[7]=a=>$e(n.value))},{default:o(()=>[...e[44]||(e[44]=[m(" 确认对账单 ",-1)])]),_:1}))])]),i("div",ft,[e[46]||(e[46]=i("h3",null,"销售明细",-1)),l(ne,{columns:fe,"data-source":G.value,"row-key":a=>a.id,pagination:{showSizeChanger:!0,pageSizeOptions:["10","20","50"],showTotal:a=>`共 ${a} 条记录`,current:Q.value,pageSize:oe.value,onChange:ye,onShowSizeChange:ge},loading:K.value},null,8,["data-source","row-key","pagination","loading"])]),i("div",null,[e[48]||(e[48]=i("h3",null,"收款记录",-1)),l(ne,{columns:_e,"data-source":J.value,"row-key":a=>a.id,pagination:!1},{empty:o(()=>[...e[47]||(e[47]=[i("p",null,"暂无收款记录",-1)])]),_:1},8,["data-source","row-key"])])])):le("",!0)]),_:1},8,["open"]),l(S,{open:D.value,"onUpdate:open":e[15]||(e[15]=a=>D.value=a),title:"录入收款",width:"600px",destroyOnClose:""},{footer:o(()=>[i("div",yt,[l(x,{onClick:e[14]||(e[14]=a=>D.value=!1)},{default:o(()=>[...e[49]||(e[49]=[m("取消",-1)])]),_:1}),l(x,{type:"primary",onClick:he},{default:o(()=>[...e[50]||(e[50]=[m("确定",-1)])]),_:1})])]),default:o(()=>[l(se,{ref_key:"receiveFormRef",ref:W,model:v,rules:ve,layout:"vertical"},{default:o(()=>[l(c,{label:"收款日期",name:"receive_date"},{default:o(()=>[l(de,{value:v.receive_date,"onUpdate:value":e[10]||(e[10]=a=>v.receive_date=a),format:"YYYY-MM-DD",style:{width:"100%"}},null,8,["value"])]),_:1}),l(c,{label:"收款金额",name:"receive_amount"},{default:o(()=>[l(C,{value:v.receive_amount,"onUpdate:value":e[11]||(e[11]=a=>v.receive_amount=a),min:.01,step:.01,precision:2,placeholder:"请输入收款金额",style:{width:"100%"}},null,8,["value"]),X.value?(b(),P("div",_t,_(X.value),1)):le("",!0)]),_:1}),l(c,{label:"收款方式",name:"receive_method"},{default:o(()=>[l(u,{value:v.receive_method,"onUpdate:value":e[12]||(e[12]=a=>v.receive_method=a),placeholder:"请选择收款方式",style:{width:"100%"},options:F.value,"not-found-content":"输入新的收款方式后按回车","show-search":"",onSearch:xe,onChange:be},null,8,["value","options"])]),_:1}),l(c,{label:"收款备注",name:"remark"},{default:o(()=>[l(Ne,{value:v.remark,"onUpdate:value":e[13]||(e[13]=a=>v.remark=a),rows:4,maxLength:200,placeholder:"请输入收款备注"},null,8,["value"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["open"]),l(S,{open:R.value,"onUpdate:open":e[16]||(e[16]=a=>R.value=a),title:Z.value,onOk:Ce,onCancel:e[17]||(e[17]=a=>R.value=!1)},{default:o(()=>[i("p",null,_(ee.value),1)]),_:1},8,["open","title"]),l(S,{open:Y.value,"onUpdate:open":e[18]||(e[18]=a=>Y.value=a),title:"删除收款记录",onOk:De,onCancel:e[19]||(e[19]=a=>Y.value=!1)},{default:o(()=>[i("p",null,_(re.value),1)]),_:1},8,["open"]),l(S,{open:I.value,"onUpdate:open":e[20]||(e[20]=a=>I.value=a),title:"确认销售对账单",width:"600px",onOk:Ee,onCancel:e[21]||(e[21]=a=>I.value=!1)},{default:o(()=>[...e[51]||(e[51]=[i("p",null,"确定要确认此对账单吗？结束日期将使用细则中选择的日期。",-1)])]),_:1},8,["open"]),l(S,{open:z.value,"onUpdate:open":e[22]||(e[22]=a=>z.value=a),title:"删除对账单",onOk:Be,onCancel:e[23]||(e[23]=a=>z.value=!1)},{default:o(()=>[i("p",null,_(me.value),1)]),_:1},8,["open"]),l(S,{open:U.value,"onUpdate:open":e[24]||(e[24]=a=>U.value=a),title:"取消确认销售对账单",onOk:Ae,onCancel:e[25]||(e[25]=a=>U.value=!1)},{default:o(()=>[i("p",null,_(ie.value),1)]),_:1},8,["open"])])}}},Ct=dt(gt,[["__scopeId","data-v-778a349d"]]);export{Ct as default};
